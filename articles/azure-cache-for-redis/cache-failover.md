---
title: 容錯移轉和修補-Azure Cache for Redis
description: 瞭解 Azure Cache for Redis 的容錯移轉、修補和更新程式。
author: asasine
ms.service: cache
ms.topic: conceptual
ms.date: 10/18/2019
ms.author: adsasine
ms.openlocfilehash: 6ff33bd594181aabc4fd7d55ce33f780a0d06086
ms.sourcegitcommit: 5a8c65d7420daee9667660d560be9d77fa93e9c9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/15/2019
ms.locfileid: "74122197"
---
# <a name="failover-and-patching-for-azure-cache-for-redis"></a>Azure Cache for Redis 的容錯移轉和修補

若要建立可復原且成功的用戶端應用程式，請務必瞭解 Azure Cache for Redis 服務內容中的容錯移轉。 容錯移轉可能是規劃管理作業的一部分，或可能是因為未計畫的硬體或網路失敗所造成。 當管理服務修補 Azure Cache for Redis 二進位檔時，通常會使用快取容錯移轉。 本文涵蓋容錯移轉的內容、修補期間的狀況，以及如何建立復原的用戶端應用程式。

## <a name="what-is-a-failover"></a>什麼是容錯移轉？

讓我們從 Azure Cache for Redis 的容錯移轉總覽開始。

### <a name="a-quick-summary-of-cache-architecture"></a>快取架構的快速摘要

快取是以不同的私人 IP 位址來構成多部虛擬機器。 每部虛擬機器（也稱為節點）都會連接到具有單一虛擬 IP 位址的共用負載平衡器。 每個節點都會執行 Redis 伺服器進程，而且可透過主機名稱和 Redis 埠來存取。 每個節點都視為主要或複本節點。 當用戶端應用程式連線到快取時，其流量會通過此負載平衡器，並自動路由傳送至主要節點。

在基本快取中，單一節點一律為「主要」。 在標準或高階快取中，有兩個節點：一個是選擇為主伺服器，另一個則是複本。 因為 Standard 和 Premium 快取有多個節點，所以一個節點可能無法使用，而另一個則會繼續處理要求。 叢集快取是由許多分區組成，每個都有不同的主要和複本節點。 其中一個分區可能會關閉，而其他則維持可用狀態。

> [!NOTE]
> 基本快取沒有多個節點，且不提供服務等級協定（SLA）的可用性。 只有在開發和測試用途時，才建議使用基本快取。 針對多重節點部署使用標準或高階快取，以提高可用性。

### <a name="explanation-of-a-failover"></a>容錯移轉的說明

當複本節點將自己升級為主要節點，而舊的主要節點關閉現有的連接時，就會發生容錯移轉。 主要節點恢復運作後，它會注意到角色的變更，並將其本身降級為複本。 然後，它會連接到新的主伺服器，並同步處理資料。 容錯移轉可能已規劃或未計畫。

*規劃的容錯移轉*會在系統更新期間發生，例如 Redis 修補或作業系統升級，以及管理作業，例如調整和重新開機。 因為節點會提前收到更新通知，所以可以合作交換角色並快速更新變更的負載平衡器。 規劃的容錯移轉通常會在小於1秒的時間內完成。

未*計畫的容錯移轉*可能是因為硬體故障、網路失敗或其他非預期的主要節點中斷所造成。 複本節點會將自己升級為 master，但進程需要較長的時間。 複本節點必須先偵測到其主要節點無法使用，然後才可以起始容錯移轉程式。 複本節點也必須確認此未計畫的失敗不是暫時性或本機，以避免發生不必要的容錯移轉。 這項偵測延遲表示，非計畫的容錯移轉通常會在10到15秒內完成。

## <a name="how-does-patching-occur"></a>如何進行修補？

Azure Cache for Redis 服務會使用最新的平臺功能和修正，定期更新您的快取。 若要修補快取，服務會遵循下列步驟：

1. 管理服務會選取一個要修補的節點。
1. 如果選取的節點是主要節點，對應的複本節點會以合作方式自行升級。 這種升級會被視為計畫的容錯移轉。
1. 選取的節點會重新開機以進行新的變更，並將其恢復為複本節點。
1. 複本節點會連接到主要節點，並同步處理資料。
1. 當資料同步完成時，會針對其餘節點重複修補程式。

由於修補是規劃的容錯移轉，因此複本節點會快速地將其本身升級為主機，並開始處理要求和新的連接。 基本快取沒有複本節點，在更新完成之前無法使用。 叢集快取的每個分區會分別進行修補，而且不會關閉與其他分區的連線。

> [!IMPORTANT]
> 系統會一次修補一個節點，以防止資料遺失。 基本快取會遺失資料。 叢集快取會一次修補一個分區。

相同資源群組和區域中的多個快取一次也會進行修補。  位於不同資源群組或不同區域的快取可能會同時進行修補。

由於完整資料同步處理會在程式重複之前進行，因此當您使用標準或高階快取時，不太可能發生資料遺失的情況。 您可以藉由[匯出](cache-how-to-import-export-data.md#export)資料並啟用[持續](cache-how-to-premium-persistence.md)性，進一步防範資料遺失。

## <a name="additional-cache-load"></a>額外的快取負載

發生容錯移轉時，Standard 和 Premium 快取必須將資料從一個節點複寫到另一個。 這項複寫會導致伺服器記憶體和 CPU 的負載增加。 如果快取實例已經過大量載入，用戶端應用程式可能會遇到延遲增加的情況。 在極端情況下，用戶端應用程式可能會收到超時例外狀況。 若要協助減輕這項額外負載的影響[，請設定快](cache-configure.md#memory-policies)取的 `maxmemory-reserved` 設定。

## <a name="how-does-a-failover-affect-my-client-application"></a>容錯移轉如何影響我的用戶端應用程式？

用戶端應用程式所看到的錯誤數目，取決於在容錯移轉時，該連線上等待的作業數。 透過關閉其連線的節點路由傳送的任何連接都會看到錯誤。 當連接中斷時，許多用戶端程式庫可能會擲回不同類型的錯誤，包括超時例外狀況、連接例外狀況或通訊端例外狀況。 例外狀況的數目和類型取決於當快取關閉其連接時，要求的程式碼路徑中的位置。 例如，在容錯移轉發生時傳送要求但未收到回應的作業，可能會收到超時例外狀況。 已關閉連線物件上的新要求會收到連接例外狀況，直到重新連線成功為止。

大部分的用戶端程式庫會嘗試重新連線至快取（如果已設定）。 不過，未預期的 bug 有時可能會將程式庫物件變成無法復原的狀態。 如果錯誤保存超過預先設定的時間長度，則應該重新建立連線物件。 在 Microsoft.NET 和其他物件導向的語言中，在不重新開機應用程式的情況下建立連接，可以藉由使用[延遲\<t\> 模式](https://gist.github.com/JonCole/925630df72be1351b21440625ff2671f#reconnecting-with-lazyt-pattern)來完成。

### <a name="how-do-i-make-my-application-resilient"></a>如何? 讓應用程式具有彈性嗎？

因為您無法完全避免容錯移轉，所以請撰寫用戶端應用程式，以取得連接中斷和失敗要求的復原能力。 雖然大部分的用戶端程式庫會自動重新連線至快取端點，但其中少數會嘗試重試失敗的要求。 視應用程式案例而定，使用重試邏輯搭配輪詢可能很有意義。

若要測試用戶端應用程式的復原功能，請使用[重新開機](cache-administration.md#reboot)作為連接中斷的手動觸發程式。 此外，建議您排定快取上的[更新](cache-administration.md#schedule-updates)。 告訴管理服務在指定的每週時段套用 Redis 執行時間修補程式。 這些視窗通常是用戶端應用程式流量較低的期間，以避免潛在的事件。

### <a name="client-network-configuration-changes"></a>用戶端網路-設定變更

某些用戶端網路設定變更可能會觸發「沒有可用的連線」錯誤。 這類變更可能包括：

- 在預備和生產位置之間交換用戶端應用程式的虛擬 IP 位址。
- 調整應用程式的實例大小或數目。

這類變更可能會導致連線問題，且持續時間不到一分鐘。 除了 Azure Cache for Redis 服務以外，您的用戶端應用程式可能會失去與其他外部網路資源的連線。

## <a name="next-steps"></a>後續步驟

- [排程](cache-administration.md#schedule-updates)快取的更新。
- 使用[重新開機](cache-administration.md#reboot)來測試應用程式恢復功能。
- [設定](cache-configure.md#memory-policies)記憶體保留和原則。
